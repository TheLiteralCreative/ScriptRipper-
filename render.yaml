# Render Blueprint - ScriptRipper+ Infrastructure as Code
# https://render.com/docs/blueprint-spec

services:
  # ============================================================================
  # API Web Service
  # ============================================================================
  - type: web
    name: scriptripper-api
    env: docker
    dockerfilePath: ./api/Dockerfile
    dockerContext: ./api
    region: oregon  # Choose: oregon, frankfurt, ohio, singapore
    plan: free  # Upgrade to 'starter' or 'standard' for production
    branch: main
    autoDeploy: true
    healthCheckPath: /health

    # Environment variables for API service
    envVars:
      # ---- Application Configuration ----
      - key: APP_NAME
        value: ScriptRipper

      - key: APP_VERSION
        value: 0.1.0

      - key: ENVIRONMENT
        value: production

      - key: LOG_LEVEL
        value: INFO

      # ---- Database Connection ----
      # Auto-populated from the PostgreSQL database service below
      - key: DATABASE_URL
        fromDatabase:
          name: scriptripper-db
          property: connectionString

      # ---- Redis Connection ----
      # MUST be manually set after creating Redis instance
      # Render Blueprint does NOT support Redis - create manually via dashboard
      - key: REDIS_URL
        sync: false  # Manual - get from Redis service after creation

      # ---- JWT Security ----
      # IMPORTANT: Copy from .env.render (auto-generated)
      - key: JWT_SECRET
        sync: false  # Manual - paste from .env.render

      - key: JWT_ALGORITHM
        value: HS256

      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: 60

      - key: REFRESH_TOKEN_EXPIRE_DAYS
        value: 7

      # ---- LLM Providers ----
      # Get from: https://makersuite.google.com/app/apikey
      - key: GEMINI_API_KEY
        sync: false  # Manual - get from Google AI Studio

      - key: OPENAI_API_KEY
        sync: false  # Optional

      - key: ANTHROPIC_API_KEY
        sync: false  # Optional

      - key: DEFAULT_LLM_PROVIDER
        value: gemini

      # ---- Google OAuth (Optional) ----
      - key: GOOGLE_CLIENT_ID
        sync: false  # Optional

      - key: GOOGLE_CLIENT_SECRET
        sync: false  # Optional

      - key: GOOGLE_REDIRECT_URI
        sync: false  # Optional

      # ---- Email (Purelymail) ----
      - key: PURELYMAIL_API_TOKEN
        sync: false  # Optional - from Purelymail dashboard

      - key: PURELYMAIL_SMTP_HOST
        value: smtp.purelymail.com

      - key: PURELYMAIL_SMTP_PORT
        value: 587

      - key: PURELYMAIL_SMTP_USER
        sync: false  # Optional - your email

      - key: PURELYMAIL_SMTP_PASS
        sync: false  # Optional - from Purelymail

      - key: FROM_EMAIL
        value: noreply@scriptripper.com

      - key: MAGIC_LINK_EXPIRE_MINUTES
        value: 15

      # ---- CORS Configuration ----
      - key: CORS_ORIGINS
        value: https://scriptripper.com,https://www.scriptripper.com

      # ---- n8n Webhooks (Optional) ----
      - key: N8N_WEBHOOK_URL
        sync: false  # Optional

      # ---- Object Storage (Optional) ----
      - key: S3_ENDPOINT_URL
        sync: false  # Optional - for S3-compatible storage

      - key: S3_ACCESS_KEY_ID
        sync: false  # Optional

      - key: S3_SECRET_ACCESS_KEY
        sync: false  # Optional

      - key: S3_BUCKET_NAME
        value: scriptripper-artifacts

      - key: S3_REGION
        value: us-east-1

      # ---- Rate Limiting ----
      - key: RATE_LIMIT_PER_MINUTE
        value: 60

      # ---- File Upload Configuration ----
      - key: MAX_UPLOAD_SIZE_MB
        value: 50

      - key: ALLOWED_EXTENSIONS
        value: json,txt,srt,vtt

      - key: MAX_TRANSCRIPT_LENGTH
        value: 500000

      # ---- Stripe Billing ----
      # Get from: https://dashboard.stripe.com/apikeys
      - key: STRIPE_SECRET_KEY
        sync: false  # Manual - from Stripe dashboard

      - key: STRIPE_PUBLISHABLE_KEY
        sync: false  # Manual - from Stripe dashboard

      # Configure webhook AFTER deployment - see RENDER_DEPLOYMENT_GUIDE.md
      - key: STRIPE_WEBHOOK_SECRET
        sync: false  # Manual - configure after deployment

      # Get from: https://dashboard.stripe.com/products
      - key: STRIPE_PRO_PRICE_ID
        sync: false  # Manual - from Stripe products

      - key: STRIPE_SUCCESS_URL
        value: https://scriptripper.com/success

      - key: STRIPE_CANCEL_URL
        value: https://scriptripper.com/pricing

      # ---- Sentry Error Tracking (Optional but Recommended) ----
      # Get from: https://sentry.io
      - key: SENTRY_DSN
        sync: false  # Optional - from Sentry project settings

      - key: SENTRY_TRACES_SAMPLE_RATE
        value: 0.1

      - key: SENTRY_PROFILES_SAMPLE_RATE
        value: 0.1

  # ============================================================================
  # Web Frontend Service (Next.js)
  # ============================================================================
  - type: web
    name: scriptripper-web
    env: docker
    dockerfilePath: ./web/Dockerfile
    dockerContext: ./web
    region: oregon  # Must match API region
    plan: free
    branch: main
    autoDeploy: true
    healthCheckPath: /

    # Environment variables for Web frontend
    envVars:
      - key: NODE_ENV
        value: production

      - key: NEXT_PUBLIC_API_URL
        value: https://api.scriptripper.com

      - key: NEXT_PUBLIC_APP_NAME
        value: ScriptRipper

      - key: NEXT_PUBLIC_APP_VERSION
        value: 0.1.0

      - key: NEXT_PUBLIC_ENABLE_CUSTOM_PROMPTS
        value: true

      - key: NEXT_PUBLIC_ENABLE_BATCH_UPLOAD
        value: true

      - key: NEXT_PUBLIC_APP_HOST
        value: https://www.scriptripper.com

      - key: NEXT_PUBLIC_MAX_FILE_SIZE_MB
        value: 50

      - key: NEXT_PUBLIC_GOOGLE_CLIENT_ID
        sync: false

  # ============================================================================
  # Background Worker Service (Stage 2 - Paid Plan)
  # ============================================================================
  - type: worker
    name: scriptripper-worker
    env: docker
    dockerfilePath: ./worker/Dockerfile
    dockerContext: ./worker
    region: oregon  # Align with API region
    plan: starter  # workers require paid plan
    branch: main
    autoDeploy: true

    envVars:
      - key: APP_NAME
        value: ScriptRipper

      - key: ENVIRONMENT
        value: production

      - key: LOG_LEVEL
        value: INFO

      - key: DATABASE_URL
        fromDatabase:
          name: scriptripper-db
          property: connectionString

      - key: REDIS_URL
        sync: false  # Populate manually once Redis is provisioned

      - key: GEMINI_API_KEY
        sync: false

      - key: OPENAI_API_KEY
        sync: false

      - key: ANTHROPIC_API_KEY
        sync: false

      - key: DEFAULT_LLM_PROVIDER
        value: gemini

      - key: PURELYMAIL_API_TOKEN
        sync: false

      - key: PURELYMAIL_SMTP_HOST
        value: smtp.purelymail.com

      - key: PURELYMAIL_SMTP_PORT
        value: 587

      - key: PURELYMAIL_SMTP_USER
        sync: false

      - key: PURELYMAIL_SMTP_PASS
        sync: false

      - key: FROM_EMAIL
        value: noreply@scriptripper.com

      - key: MAX_TRANSCRIPT_LENGTH
        value: 500000

      - key: SENTRY_DSN
        sync: false

# ============================================================================
# Database Services
# ============================================================================
databases:
  # PostgreSQL Database
  - name: scriptripper-db
    databaseName: scriptripper_production
    user: scriptripper
    region: oregon  # Should match services region
    plan: free  # Free tier: 256MB RAM, 1GB storage
    # Upgrade plans: https://render.com/pricing#databases
    # - starter: $7/mo - 1GB RAM, 10GB storage
    # - standard: $20/mo - 4GB RAM, 100GB storage
    ipAllowList: []  # Empty = allow all Render services (recommended)
