# Prompt Synchronization Guide

**Last Updated:** 2025-11-19
**Status:** Files synced ‚úÖ | Database sync pending ‚è≥

## What Was Accomplished

### ‚úÖ Successfully Completed

1. **Created Reusable Sync Script** (`/scripts/sync-prompts.js`)
   - Parses markdown files with tightened prompts
   - Archives old prompts automatically
   - Updates JSON files in web and API directories
   - Updates PROMPT_DESCRIPTIONS in configure page
   - Syncs to database via admin API

2. **Updated All JSON Files**
   - `web/src/app/configure/prompts/meetings_prompts.json` (11 prompts)
   - `web/src/app/configure/prompts/presentations_prompts.json` (7 prompts)
   - `api/scripts/meetings_prompts.json`
   - `api/scripts/presentations_prompts.json`

3. **Updated Configure Page UI**
   - `web/src/app/configure/page.tsx` - PROMPT_DESCRIPTIONS object
   - All descriptions now in What/Why/How/Who format

4. **Created Archives**
   - Old prompts backed up to `prompt-archive/versions/2025-11-19T06-31-54/`
   - Includes `changes.md` documenting the update

### üìä Prompt Changes

**New/Updated Task Names:**
- `Action Items Table` ‚Üí `Action Items Tracker`
- `Client-Expectations` ‚Üí `Client Expectations Report`
- `Disagreements & Unresolved Issues` ‚Üí `Friction & Foresight Report`
- `Key-Insights` ‚Üí `Communication Insights (SSC)`
- `Deep-Outline` + `Expanded Outline` ‚Üí `Timestamped Outline & Recipes` (merged)
- **NEW:** `Tutorial Step-Down & Actionable How-To Extractor`

**Prompt Format Improvements:**
All prompts now follow 4-part structure:
1. Role & Goal
2. Core Instruction
3. Formatting Constraints
4. Negative Constraints

---

## ‚ö†Ô∏è What Failed: Database Sync Issues

### Problem Summary

The database sync via admin API failed with `401: Invalid or expired token` errors across multiple attempts.

### What We Tried (In Order)

#### ‚ùå Attempt 1: Token from .env.rtf
```bash
ACCESS_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
API_URL=https://www.scriptripper.com
```
**Result:** `HTTP 401: Invalid or expired token`
**Why it failed:** Token was likely old/expired

#### ‚ùå Attempt 2: Fresh token from DevTools ‚Üí localhost API
```bash
ACCESS_TOKEN=<fresh_token_from_browser>
API_URL=http://localhost:8000
```
**Result:** `HTTP 401: Invalid or expired token`
**Why it failed:** Token generated by production (www.scriptripper.com) but trying to authenticate against local dev API with different JWT secret

#### ‚ùå Attempt 3: Fresh token ‚Üí api.scriptripper.com
```bash
API_URL=https://api.scriptripper.com
```
**Result:** `SSL/TLS alert handshake failure`
**Why it failed:** DNS/SSL misconfiguration or api.scriptripper.com doesn't exist

#### ‚ùå Attempt 4: Fresh token ‚Üí Render production API
```bash
API_URL=https://scriptripper-api.onrender.com
```
**Result:** `HTTP 401: Invalid or expired token`
**Why it failed:** Token might be environment-specific or expired by this point

---

## üö´ What NOT to Do (Lessons Learned)

### 1. ‚ùå DON'T Use Tokens Across Different Environments

**Problem:**
```bash
# Token from www.scriptripper.com
ACCESS_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Trying to use with localhost API
API_URL=http://localhost:8000
```

**Why it fails:**
- Production and local environments have different `JWT_SECRET` values
- Tokens signed with one secret can't be verified by another
- Each environment generates its own tokens

**Do this instead:**
- Use tokens from the same environment you're targeting
- Local dev ‚Üí get token from localhost frontend
- Production ‚Üí get token from production frontend

### 2. ‚ùå DON'T Store Tokens in .rtf Files

**Problem:**
```
/Users/.../ScriptRipper+/.env.rtf
```

**Why it fails:**
- RTF files contain formatting markup
- Plain text parsing will include RTF codes
- Tokens get corrupted

**Do this instead:**
```bash
# Use plain text .env file
/Users/.../ScriptRipper+/.env
```

### 3. ‚ùå DON'T Assume API Endpoints Without Checking

**Attempts we made:**
- `https://www.scriptripper.com/api/v1/admin/prompts` ‚ùå
- `https://api.scriptripper.com/api/v1/admin/prompts` ‚ùå
- `http://localhost:8000/api/v1/admin/prompts` ‚ùå
- `https://scriptripper-api.onrender.com/api/v1/admin/prompts` ‚úì (correct but token failed)

**Do this instead:**
1. Check `.env.production` for correct API URL
2. Or ask which environment to target first
3. Verify with: `curl https://[API_URL]/api/v1/health`

### 4. ‚ùå DON'T Paste Sensitive Tokens in Conversation

**What happened:**
- User wisely asked before pasting token
- Tokens grant admin access to entire system

**Do this instead:**
- Store in `.env` file (already in `.gitignore`)
- Pass via environment variable
- Or use script's interactive prompt (if we add that feature)

### 5. ‚ùå DON'T Mix Refresh Tokens and Access Tokens

**What happened:**
- User copied both tokens from DevTools
- Refresh token: `...InJlZnJlc2gifQ...` (type: refresh)
- Access token: `...ImFjY2VzcyJ9...` (type: access)

**Do this instead:**
- Use only the **access_token** for API calls
- Refresh tokens are for getting new access tokens
- Check the token payload: `jwt.io` can decode and show type

---

## ‚úÖ Recommended Approaches for Future

### Option 1: Manual Admin UI Update (Safest)

When database sync fails, update prompts manually:

1. Go to https://www.scriptripper.com/admin/prompts
2. Reference the markdown file or archived JSONs
3. Click Edit on each prompt
4. Update description and prompt_json fields
5. Save

**Pros:**
- No authentication issues
- Visual confirmation of changes
- Can review each prompt before saving

**Cons:**
- Time-consuming for bulk updates
- Manual copy-paste prone to errors

### Option 2: Sync Script with Correct Environment (Fastest)

Use the sync script when you have the right setup:

```bash
cd /Users/superiorcommunicator/Agents/ScriptRipper/ScriptRipper+

# 1. Make sure you're logged into the target environment
#    (e.g., visit https://www.scriptripper.com and log in)

# 2. Get fresh access token from DevTools ‚Üí Local Storage ‚Üí access_token

# 3. Update .env with correct API URL and token
cat > .env << 'EOF'
ACCESS_TOKEN=<paste_fresh_token_here>
API_URL=https://scriptripper-api.onrender.com
EOF

# 4. Run the sync script
node scripts/sync-prompts.js ./path/to/prompts.md
```

**Pros:**
- Fast bulk updates
- Automatic archiving
- Updates all systems (JSON + DB + UI)

**Cons:**
- Requires valid authentication
- More complex troubleshooting

### Option 3: Deploy & Let System Self-Sync

Since JSON files are already updated:

1. Commit and push changes
2. Deploy to production
3. Restart API service
4. API will read from updated JSON files
5. Admin page will show new content on next load

**Pros:**
- Leverages existing deployment pipeline
- No manual database manipulation needed
- Changes are version-controlled

**Cons:**
- Requires deployment cycle
- May need cache clearing

---

## üîß How to Use the Sync Script

### Script Location
```
/Users/superiorcommunicator/Agents/ScriptRipper/ScriptRipper+/scripts/sync-prompts.js
```

### Basic Usage

```bash
node scripts/sync-prompts.js <path-to-markdown-file> [access-token]
```

### With .env File (Recommended)

```bash
# 1. Create .env in project root
cat > .env << 'EOF'
ACCESS_TOKEN=your_token_here
API_URL=https://scriptripper-api.onrender.com
EOF

# 2. Run script (will auto-load .env)
node scripts/sync-prompts.js ./path/to/prompts.md
```

### What the Script Does

1. **Parses** markdown file for prompts
2. **Archives** current prompts with timestamp
3. **Updates** JSON files in web/api directories
4. **Updates** PROMPT_DESCRIPTIONS in configure page
5. **Syncs** to database via admin API (if token provided)

### Expected Output

```
üöÄ Starting Prompt Sync Process...

üìñ Reading markdown file: /path/to/prompts.md
‚úÖ Parsed 18 prompts from markdown
üì¶ Archiving current prompts to: prompt-archive/versions/2025-11-19T06-31-54
‚úÖ Archived to prompt-archive/versions/2025-11-19T06-31-54
üìù Updating JSON files...
‚úÖ Updated JSON files (11 meetings, 7 presentations)
üìÑ Updating configure page PROMPT_DESCRIPTIONS...
‚úÖ Updated configure page
üóÑÔ∏è  Updating database via admin API...
üìä Found 21 existing prompts in database
  ‚úèÔ∏è  Updated: Action Items Tracker
  ‚úèÔ∏è  Updated: Key Decisions Log
  ‚ûï Created: Tutorial Step-Down & Actionable How-To Extractor
  ...

‚úÖ Database sync complete: 1 created, 17 updated, 0 errors

üéâ Prompt sync completed successfully!
```

---

## üìÅ File Structure Reference

```
ScriptRipper+/
‚îú‚îÄ‚îÄ .env                                    # Environment config (tokens)
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ sync-prompts.js                     # Sync automation script
‚îú‚îÄ‚îÄ web/src/app/configure/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                            # Contains PROMPT_DESCRIPTIONS
‚îÇ   ‚îî‚îÄ‚îÄ prompts/
‚îÇ       ‚îú‚îÄ‚îÄ meetings_prompts.json           # User-facing prompts
‚îÇ       ‚îî‚îÄ‚îÄ presentations_prompts.json
‚îú‚îÄ‚îÄ api/scripts/
‚îÇ   ‚îú‚îÄ‚îÄ meetings_prompts.json               # API reference copy
‚îÇ   ‚îî‚îÄ‚îÄ presentations_prompts.json
‚îî‚îÄ‚îÄ prompt-archive/
    ‚îú‚îÄ‚îÄ versions/
    ‚îÇ   ‚îî‚îÄ‚îÄ 2025-11-19T06-31-54/            # Timestamped backups
    ‚îÇ       ‚îú‚îÄ‚îÄ meetings_prompts.json
    ‚îÇ       ‚îú‚îÄ‚îÄ presentations_prompts.json
    ‚îÇ       ‚îî‚îÄ‚îÄ changes.md
    ‚îî‚îÄ‚îÄ custom/
        ‚îú‚îÄ‚îÄ pending/                         # Custom prompts to review
        ‚îî‚îÄ‚îÄ approved/                        # Approved customs
```

---

## üéØ Current Status

### What's Working Now

1. **User Configuration Page** ‚úÖ
   - Shows new prompt names
   - Displays new What/Why/How/Who descriptions
   - Users can select new prompts

2. **JSON Files** ‚úÖ
   - All prompt files updated with tightened formats
   - Backups created in archive

3. **Sync Script** ‚úÖ
   - Ready for future bulk updates
   - Supports .env configuration

### What Needs Manual Fix

1. **Admin Prompts Page** ‚ö†Ô∏è
   - Still shows old database content
   - Needs manual update via UI OR
   - Fresh token + script re-run OR
   - Wait for next deployment

### Next Steps (Pick One)

**Option A: Manual Update**
- Visit /admin/prompts
- Edit each prompt with new content
- Reference: `prompt-archive/versions/2025-11-19T06-31-54/`

**Option B: Retry Script Sync**
- Get fresh token from production site
- Update `.env` with correct API URL
- Re-run: `node scripts/sync-prompts.js <markdown-path>`

**Option C: Deploy & Forget**
- Commit changes
- Push to production
- Let system self-update on next deploy

---

## üêõ Troubleshooting

### "Invalid or expired token"

**Cause:** Token is old, wrong environment, or JWT secret mismatch

**Fix:**
1. Log out and back in to the target environment
2. Get fresh token from DevTools ‚Üí Application ‚Üí Local Storage ‚Üí access_token
3. Ensure API_URL matches where token came from:
   - Token from www.scriptripper.com ‚Üí use scriptripper-api.onrender.com
   - Token from localhost:3000 ‚Üí use localhost:8000

### "SSL handshake failure"

**Cause:** Incorrect API endpoint or DNS issues

**Fix:**
1. Check `.env.production` for correct API URL
2. Verify endpoint exists: `curl https://[API_URL]/api/v1/health`
3. Use Render URL: `https://scriptripper-api.onrender.com`

### "Module not found: axios"

**Cause:** Script tried to use axios but we removed it

**Fix:** Already fixed - script now uses native Node.js `http`/`https`

---

## üìù Notes for Future Updates

1. **Always archive first** - Script does this automatically
2. **Test on local/dev first** if possible
3. **Document prompt changes** in the generated `changes.md`
4. **Keep markdown source files** for future reference
5. **Version control everything** except .env files

---

## üîí Security Reminders

- Never commit `.env` files (already in `.gitignore`)
- Never paste access tokens in public channels
- Tokens expire - get fresh ones when needed
- Use separate tokens for dev vs production
- Store production tokens securely (password manager)

---

## Questions?

If issues persist:
1. Check this guide's troubleshooting section
2. Review script output for specific errors
3. Verify environment configuration
4. Consider manual admin UI update as fallback
