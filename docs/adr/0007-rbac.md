# ADR-0007: RBAC – Admin/User

**Status**: Accepted
**Date**: 2025-11-02
**Deciders**: Project Team

## Context
Need role-based access control that:
- Protects sensitive operations (profile management)
- Allows users to manage their own resources
- Remains simple for MVP (no multi-tenant complexity)
- Provides foundation for future expansion

## Decision
Implement two-role system:

### Admin Role
- Create, update, delete, publish profiles
- View all jobs and users (within single tenant)
- Configure system settings
- Access admin dashboard
- Manage user roles

### User Role (Default)
- Create and manage own jobs
- View and use published profiles (read-only)
- Access own job history and artifacts
- Generate API tokens for CLI
- Update own account settings

## Rationale
1. **Simplicity**: Two roles cover MVP requirements
2. **Clear Separation**: Profile management vs. job execution
3. **Security**: Sensitive operations protected
4. **Scalability**: Easy to extend with more roles later

## Consequences

### Positive
- Simple to implement and understand
- Clear permission boundaries
- Easy to test
- Foundation for future RBAC expansion

### Negative
- Limited granularity (no per-resource permissions)
- No concept of teams/organizations
- Admin has broad permissions

### Neutral
- May need to extend for V1+ features
- Role stored in user table (simple, not normalized)

## Permission Matrix

| Action | User | Admin |
|--------|------|-------|
| **Authentication** |
| Sign in | ✓ | ✓ |
| View own profile | ✓ | ✓ |
| Update own profile | ✓ | ✓ |
| **Jobs** |
| Create job | ✓ | ✓ |
| View own jobs | ✓ | ✓ |
| View all jobs | ✗ | ✓ |
| Delete own job | ✓ | ✓ |
| Delete any job | ✗ | ✓ |
| **Profiles** |
| List published profiles | ✓ | ✓ |
| View profile details | ✓ | ✓ |
| Create profile | ✗ | ✓ |
| Update profile | ✗ | ✓ |
| Delete profile | ✗ | ✓ |
| Publish/unpublish profile | ✗ | ✓ |
| **Custom Prompts** |
| Run custom prompt (own job) | ✓ | ✓ |
| Run custom prompt (any job) | ✗ | ✓ |
| **Artifacts** |
| Download own artifacts | ✓ | ✓ |
| Download any artifacts | ✗ | ✓ |
| **API Tokens** |
| Generate own tokens | ✓ | ✓ |
| Revoke own tokens | ✓ | ✓ |
| View/revoke any tokens | ✗ | ✓ |

## Implementation Details

### Database Schema
```sql
CREATE TYPE user_role AS ENUM ('user', 'admin');

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  role user_role NOT NULL DEFAULT 'user',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Middleware
- Check JWT token for user ID and role
- Enforce permissions at route level
- Return 403 Forbidden for unauthorized actions

### FastAPI Example
```python
from fastapi import Depends, HTTPException, status
from enum import Enum

class Role(str, Enum):
    USER = "user"
    ADMIN = "admin"

def require_role(required_role: Role):
    def role_checker(current_user: User = Depends(get_current_user)):
        if current_user.role != required_role:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Insufficient permissions"
            )
        return current_user
    return role_checker

@app.post("/api/v1/profiles")
async def create_profile(
    profile: ProfileCreate,
    user: User = Depends(require_role(Role.ADMIN))
):
    # Only admins can create profiles
    ...
```

## Future Extensions (V1+)
- **Viewer Role**: Read-only access to jobs/profiles
- **Organization Roles**: Owner, Member, Guest
- **Resource-Level Permissions**: Share specific jobs with other users
- **API Key Scopes**: Fine-grained permissions for tokens

## Alternatives Considered

### Alternative A: Single role (all users equal)
**Pros**: Maximum simplicity
**Cons**: No protection for profile management, security risk

### Alternative B: Complex RBAC (permissions per resource)
**Pros**: Maximum flexibility
**Cons**: Overkill for MVP, slower development

### Alternative C: Organization-based (multi-tenant from start)
**Pros**: Future-proof
**Cons**: Premature complexity, slows MVP

## References
- SPEC §3, §7
- [OWASP Authorization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html)
